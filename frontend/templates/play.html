{% extends "base.html" %}

{% block content %}
<h1>Play Game</h1>
<div class="form-group">
    <label for="gameSelect">Select Game:</label>
    <select class="form-control" id="gameSelect">
        {% if games %}
            {% for game in games %}
            <option value="{{ game.id }}">{{ game.id }}</option>
            {% endfor %}
        {% endif %}
    </select>
</div>
<div id="generalGameInfoContainer">
</div>
<div id="playersContainer">
    <!-- Players, their cards, sliders, slider values, and buttons will be displayed here -->
</div>

<script>
$(document).ready(function() {
    var FASTAPI_URL = "{{ FASTAPI_URL }}";
    let twoCardsToBeGiven = [];

    // Event handler for card buttons
    $(document).on('click', '.card-btn', function() {
        const gameId = $(this).data('gameId');
        const playerId = $(this).data('playerId');
        const card = $(this).data('card');

        const gameState = $(this).data('gameState'); // Assuming gameState is passed as a data attribute

        if (gameState === 'give_two_cards') {
            twoCardsToBeGiven.push(card);
            if (twoCardsToBeGiven.length === 2) {
                $.ajax({
                    url: `${FASTAPI_URL}/game/${gameId}/give_two_cards?player_id=${playerId}&card1=${twoCardsToBeGiven[0]}&card2=${twoCardsToBeGiven[1]}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    success: function(response) {
                        alert(response);
                        $('#gameSelect').trigger('change'); // Reload the players and their cards
                        twoCardsToBeGiven = []; // Reset the selected cards
                    },
                    error: function(xhr) {
                        alert('Failed to give cards. Error: ' + xhr.responseText);
                        twoCardsToBeGiven = []; // Reset the selected cards in case of an error
                    }
                });
            }
        } else {
            $.ajax({
                url: `${FASTAPI_URL}/game/${gameId}/play_card?player_id=${playerId}&card=${card}`,
                type: 'PUT',
                contentType: 'application/json',
                success: function(response) {
                    $('#gameSelect').trigger('change'); // Reload the players and their cards
                },
                error: function(xhr) {
                    alert('Failed to play card. Error: ' + xhr.responseText);
                }
            });
        }
    });

    $('#gameSelect').on('change', function() {
        const gameId = $(this).val();
        $.get(`${FASTAPI_URL}/game/${gameId}`, function(gameData) {
            $.get(`${FASTAPI_URL}/game/${gameId}/current_round`, function(roundData) {
                $.get(`${FASTAPI_URL}/game/${gameId}/players`, function(playersData) {
                    $('#generalGameInfoContainer').empty();
                    const gameInfo = $('<div class="info-paragraph">').appendTo('#generalGameInfoContainer');
                    $('<p>').html(`Current Round: <span class="highlight">${gameData.current_round}</span>`).appendTo(gameInfo);
                    $('<p>').html(`Game State: <span class="highlight">${gameData.game_state}</span>`).appendTo(gameInfo);
                    $('<p>').html(`Talon: <span class="highlight">${roundData.talon}</span>`).appendTo(gameInfo);
                    $('<p>').html(`Trick: <span class="highlight">${roundData.trick}</span>`).appendTo(gameInfo);
                    $('<p>').html(`Trick Turn: <span class="highlight">${roundData.trick_turn}</span>`).appendTo(gameInfo);
                    $('<p>').html(`Marriage: <span class="highlight">${roundData.activated_pair}</span>`).appendTo(gameInfo);

                    const newRoundButtonDiv = $('<div>').appendTo('#generalGameInfoContainer');

                    $('<button>').text('New Round').addClass('btn btn-primary').appendTo(newRoundButtonDiv);

                    $('#playersContainer').empty();
                    const players = [gameData.player0, gameData.player1, gameData.player2];
                    bidsData = roundData.bids.split(',');

                    playersData.forEach((playerData, index) => {
                        const playerDiv = $('<div>').addClass('player').appendTo('#playersContainer');

                        if (index === roundData.trick_turn && gameData.game_state === "playing" ||
                        roundData.bid_turn == index && gameData.game_state === "bidding") {
                            $('<h3 style="color: green">').text(`Player ${playerData.id}: ${playerData.point} (${playerData.round_point})`).appendTo(playerDiv);
                        }
                        else if (bidsData[index] == "-1" && (gameData.game_state === "bidding" || gameData.game_state === "rebidding")){
                            $('<h3 style="color: gray">').text(`Player ${playerData.id}: ${playerData.point} (${playerData.round_point})`).appendTo(playerDiv);
                        }
                        else {
                            $('<h3>').text(`Player ${playerData.id}: ${playerData.point} (${playerData.round_point})`).appendTo(playerDiv);
                        }
                        const cardsDiv = $('<div>').addClass('cards').appendTo(playerDiv);

                        if (gameData.game_state == "bidding" || gameData.game_state == "rebidding") {
                            // Add slider for each player
                            const sliderDiv = $('<div>').appendTo(playerDiv);
                            const slider = $('<input type="range">')
                                .attr('id', `sliderPlayer${index}`)
                                .attr('min', gameData.game_state === "bidding" ? roundData.final_bid_amount + 10 : roundData.final_bid_amount)
                                .attr('max', playerData.max_biddable_amount)
                                .attr('value', gameData.game_state === "bidding" ? roundData.final_bid_amount + 10 : roundData.final_bid_amount) // Default value
                                .appendTo(sliderDiv);
                            const sliderValue = $('<span>').text(slider.val()).appendTo(sliderDiv);

                            // Slider change event handler
                            slider.on('input', function() {
                                sliderValue.text($(this).val());
                            });

                            // Add buttons for bidding and passing
                            const passBidButtonsDiv = $('<div>').appendTo(playerDiv);
                            $('<button>').text('Bid').addClass('btn btn-primary').appendTo(passBidButtonsDiv);
                            $('<button>').text('Pass').addClass('btn btn-danger').appendTo(passBidButtonsDiv);

                            // pass bid Button click event handlers
                            passBidButtonsDiv.find('button').on('click', function() {
                                const bidValue = slider.val();
                                const action = $(this).text().toLowerCase(); // 'bid' or 'pass'
                                const endpoint = action === 'bid' ? 'bid' : 'pass';
                                // Call the corresponding endpoint
                                if( action === 'bid' && gameData.game_state == "bidding") {
                                    $.ajax({
                                        url: `${FASTAPI_URL}/game/${gameId}/make_bid?player_id=${playerData.id}&bid=${bidValue}`,
                                        type: 'PUT',
                                        contentType: 'application/json',
                                        success: function(response) {
                                            alert(response);
                                            $('#gameSelect').trigger('change'); // Reload the players and their cards
                                        },
                                        error: function(xhr) {
                                            alert('Failed to bid. Error: ' + xhr.responseText);
                                        }
                                    });
                                }
                                else if( action === 'bid' && gameData.game_state == "rebidding") {
                                    $.ajax({
                                        url: `${FASTAPI_URL}/game/${gameId}/make_final_bid?player_id=${playerData.id}&final_bid=${bidValue}`,
                                        type: 'PUT',
                                        contentType: 'application/json',
                                        success: function(response) {
                                            alert(response);
                                            $('#gameSelect').trigger('change'); // Reload the players and their cards
                                        },
                                        error: function(xhr) {
                                            alert('Failed to final bid. Error: ' + xhr.responseText);
                                        }
                                    });
                                }
                                else if( action === 'pass' ) {
                                    $.ajax({
                                        url: `${FASTAPI_URL}/game/${gameId}/pass_bid?player_id=${playerData.id}`,
                                        type: 'PUT',
                                        contentType: 'application/json',
                                        success: function(response) {
                                            alert('Passed successfully!');
                                            $('#gameSelect').trigger('change'); // Reload the players and their cards
                                        },
                                        error: function(xhr) {
                                            alert('Failed to pass. Error: ' + xhr.responseText);
                                        }
                                    });
                                }
                            });
                        }
                        if (gameData.game_state == "talon") {
                            const takeTalonDiv = $('<div>').appendTo(playerDiv);
                            $('<button>').text('Take').addClass('btn btn-primary').appendTo(takeTalonDiv);
                            $('<button>').text('Fold').addClass('btn btn-danger').appendTo(takeTalonDiv);

                            takeTalonDiv.find('button').on('click', function() {
                                if ($(this).text().toLowerCase() == "take") {
                                    $.ajax({
                                        url: `${FASTAPI_URL}/game/${gameId}/take_talon?player_id=${playerData.id}`,
                                        type: 'PUT',
                                        contentType: 'application/json',
                                        success: function(response) {
                                            alert('Took talon successfully!');
                                            $('#gameSelect').trigger('change'); // Reload the players and their cards
                                        },
                                        error: function(xhr) {
                                            alert('Failed to take talon. Error: ' + xhr.responseText);
                                        }
                                    });
                                }
                            });
                        }
                        if (gameData.game_state == "rebidding") {

                        }
                        // Fetch and display player's cards
                        const cards = playerData.cards_current.split(',');
                        cards.forEach(card => {
                            $('<button>')
                                .addClass('btn btn-secondary card-btn')
                                .text(card)
                                .data('gameId', gameId)
                                .data('playerId', playerData.id)
                                .data('card', card)
                                .data('gameState', gameData.game_state) // Set the game state for the button
                                .appendTo(cardsDiv);
                        });
                    });
                    newRoundButtonDiv.find('button').on('click', function() {
                        $.ajax({
                            url: `${FASTAPI_URL}/game/${gameId}/start_round`,
                            type: 'PUT',
                            contentType: 'application/json',
                            success: function(response) {
                                alert('Started a new round successfully!');
                                $('#gameSelect').trigger('change'); // Reload the players and their cards
                            },
                            error: function(xhr) {
                                alert('Failed to start a new round. Error: ' + xhr.responseText);
                            }
                        });
                    });
                });
            });
        });
    });
    $('#gameSelect').trigger('change');
});

</script>
{% endblock %}
